<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Globo de Nieve VR — Gaze Trigger</title>
  <style>
    body { margin: 0; overflow: hidden; background: #111; }
    #info {
      position: absolute; left: 10px; top: 10px;
      color: white; font-family: sans-serif;
      background: rgba(0,0,0,0.4); padding: 8px 12px; border-radius: 6px;
      z-index: 10;
    }
  </style>
</head>
<body>
  <div id="info">Mira la CASA, el PINGÜINO o el ÁRBOL por 2s para iniciar el recorrido.</div>

  <script type="importmap">
  {
    "imports": {
      "three": "./js/three.module.js",
      "three/VRButton": "./js/VRButton.js"
    }
  }
  </script>

  <script type="module">
    import * as THREE from 'three';
    import { VRButton } from 'three/VRButton';
    import { TWEEN } from './js/tween.module.min.js';
    var renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.xr.enabled = true;
    document.body.appendChild(renderer.domElement);
    document.body.appendChild(VRButton.createButton(renderer));

    var scene = new THREE.Scene();
    scene.background = new THREE.Color(0x202030);

    var camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(0, 1.6, 3);

    var cameraRig = new THREE.Group();
    cameraRig.add(camera);
    scene.add(cameraRig);

    var ambient = new THREE.AmbientLight(0xffffff, 0.7);
    scene.add(ambient);

    var dir = new THREE.DirectionalLight(0xffffff, 0.6);
    dir.position.set(5, 10, 7);
    scene.add(dir);

    var loader = new THREE.TextureLoader();
    loader.load('./assets/images.jpg', tex => scene.background = tex);

    var mundo = new THREE.Group();

    var plane = new THREE.Mesh(
      new THREE.PlaneGeometry(80, 80),
      new THREE.MeshLambertMaterial({ color: 0xeb521e })
    );
    plane.rotation.x = -Math.PI / 2;
    scene.add(plane);

    // ----------------------------- CASA -----------------------------
    var casa = new THREE.Group();
    casa.position.set(0, 1, 0);
    casa.scale.set(0.2, 0.2, 0.2);
    mundo.add(casa);

    var cuerpoCasa = new THREE.Mesh(
      new THREE.CylinderGeometry(7, 7, 10, 32),
      new THREE.MeshLambertMaterial({ color: 0xd62828 })
    );
    cuerpoCasa.position.y = 5;
    casa.add(cuerpoCasa);

    var nieveTecho = new THREE.Mesh(
      new THREE.SphereGeometry(8, 32, 32),
      new THREE.MeshLambertMaterial({ color: 0xffffff })
    );
    nieveTecho.scale.y = 0.5;
    nieveTecho.position.y = 10;
    casa.add(nieveTecho);

    var sombrero = new THREE.Group();
    sombrero.position.y = 12;
    casa.add(sombrero);

    var hatBase = new THREE.Mesh(
      new THREE.ConeGeometry(5, 6, 32),
      new THREE.MeshLambertMaterial({ color: 0xff0000 })
    );
    hatBase.rotation.z = 0.4;
    sombrero.add(hatBase);

    var pompom = new THREE.Mesh(
      new THREE.SphereGeometry(1.3, 16, 16),
      new THREE.MeshLambertMaterial({ color: 0xffffff })
    );
    pompom.position.set(2.5, -0.5, 0);
    sombrero.add(pompom);

    var faja = new THREE.Mesh(
      new THREE.TorusGeometry(3.3, 0.7, 16, 32),
      new THREE.MeshLambertMaterial({ color: 0xffffff })
    );
    faja.rotation.x = Math.PI / 2;
    faja.position.y = -2;
    sombrero.add(faja);

    var ventana = new THREE.Mesh(
      new THREE.CylinderGeometry(1.5, 1.5, 0.3, 32),
      new THREE.MeshLambertMaterial({ color: 0x87b0ff, emissive: 0x2244ff })
    );
    ventana.rotation.x = Math.PI / 2;
    ventana.position.set(0, 7, 7.3);
    casa.add(ventana);

    function bastonCasa(x){
      var palo = new THREE.Mesh(
        new THREE.CylinderGeometry(0.4, 0.4, 6, 16),
        new THREE.MeshLambertMaterial({ color: 0xffffff })
      );
      var stripes = new THREE.Mesh(
        new THREE.CylinderGeometry(0.45, 0.45, 6, 16, 1, true),
        new THREE.MeshLambertMaterial({ color: 0xff0000, transparent:true, opacity:0.7 })
      );
      stripes.rotation.y = Math.PI/8;
      var holder = new THREE.Group();
      holder.position.set(x,3,7.2);
      holder.rotation.z = Math.PI/20;
      holder.add(palo,stripes);
      casa.add(holder);
    }
    bastonCasa(-5); bastonCasa(5);

    var ginger = new THREE.Group();
    ginger.position.set(0,3,7.3);
    casa.add(ginger);

    var bodyG = new THREE.Mesh(
      new THREE.BoxGeometry(2,3,0.4),
      new THREE.MeshLambertMaterial({ color: 0xcd7f32 })
    );
    bodyG.position.y = 1.5; ginger.add(bodyG);

    var headG = new THREE.Mesh(
      new THREE.SphereGeometry(1,16,16),
      new THREE.MeshLambertMaterial({ color: 0xcd7f32 })
    );
    headG.position.y = 3.5; ginger.add(headG);

    // ----------------------------- ARBOL -----------------------------
    var tree = new THREE.Group();
    tree.position.set(6, 1, -1);
    mundo.add(tree);

    var tronco = new THREE.Mesh(
      new THREE.CylinderGeometry(1,1,3,16),
      new THREE.MeshLambertMaterial({ color: 0x8b4513 })
    );
    tronco.position.y = 1.5; 
    tree.add(tronco);

    for (var i=0; i<3; i++){
      var capa = new THREE.Mesh(
        new THREE.ConeGeometry(4-i,3,16),
        new THREE.MeshLambertMaterial({ color: 0x2e7d32 })
      );
      capa.position.y = 3 + i*1.8;
      tree.add(capa);
    }

    // ----------------------------- PINGÜINO -----------------------------
    var blackMat = new THREE.MeshLambertMaterial({ color: 0x000000 });
    var whiteMat = new THREE.MeshLambertMaterial({ color: 0xffffff });
    var orangeMat = new THREE.MeshLambertMaterial({ color: 0xffa500 });

    var pinguino = new THREE.Group();
    pinguino.position.set(-6, 1.5, -2.5);
    mundo.add(pinguino);

    var pBody = new THREE.Mesh(new THREE.SphereGeometry(0.9, 32, 32), blackMat);
    pinguino.add(pBody);

    var belly = new THREE.Mesh(new THREE.SphereGeometry(0.6, 32, 32), whiteMat);
    belly.position.set(0,-0.1,0.4);
    pinguino.add(belly);

    var headP = new THREE.Mesh(new THREE.SphereGeometry(0.5,32,32), blackMat);
    headP.position.set(0,0.9,0);
    pinguino.add(headP);

    var eye1 = new THREE.Mesh(new THREE.SphereGeometry(0.06), whiteMat);
    eye1.position.set(0.18,1.0,0.3);
    pinguino.add(eye1);

    var eye2 = eye1.clone(); 
    eye2.position.x = -0.18;
    pinguino.add(eye2);

    var pupil1 = new THREE.Mesh(new THREE.SphereGeometry(0.03), blackMat);
    pupil1.position.set(0.18,1.0,0.36);
    pinguino.add(pupil1);

    var pupil2 = pupil1.clone();
    pupil2.position.x = -0.18;
    pinguino.add(pupil2);

    var beak = new THREE.Mesh(new THREE.ConeGeometry(0.08,0.2,16), orangeMat);
    beak.rotation.x = Math.PI/2;
    beak.position.set(0,0.85,0.32);
    pinguino.add(beak);

    var wingL = new THREE.Mesh(new THREE.BoxGeometry(0.18,0.6,0.18), blackMat);
    wingL.position.set(0.8,0.2,0);
    wingL.rotation.z = -0.5;
    pinguino.add(wingL);

    var wingR = wingL.clone();
    wingR.position.x = -0.8;
    wingR.rotation.z = 0.5;
    pinguino.add(wingR);

    var footL = new THREE.Mesh(new THREE.BoxGeometry(0.25,0.08,0.3), orangeMat);
    footL.position.set(0.25,-0.9,0.2);
    pinguino.add(footL);

    var footR = footL.clone();
    footR.position.x = -0.25;
    pinguino.add(footR);

    var regalo = new THREE.Mesh(
      new THREE.BoxGeometry(0.6,0.6,0.6),
      new THREE.MeshLambertMaterial({ color: 0xff0000 })
    );
    regalo.position.set(1.2, 0.3, -0.2);
    mundo.add(regalo);

    // ----------------------------- GLOBO -----------------------------
    var globo = new THREE.Group();
    globo.position.set(0, 0, 0);
    scene.add(globo);

    var GLOBO_RADIO = 10;

    var baseGlobo = new THREE.Mesh(
      new THREE.CylinderGeometry(GLOBO_RADIO * 0.7, GLOBO_RADIO * 0.8, GLOBO_RADIO * 0.2, 32),
      new THREE.MeshLambertMaterial({ color: 0x5b3a1e })
    );
    baseGlobo.position.y = -GLOBO_RADIO * 0.1;
    globo.add(baseGlobo);

    var cristal = new THREE.Mesh(
      new THREE.SphereGeometry(GLOBO_RADIO, 64, 64),
      new THREE.MeshLambertMaterial({
        color: 0xffffff,
        transparent: true,
        opacity: 0.25,
        side: THREE.DoubleSide
      })
    );
    cristal.position.y = GLOBO_RADIO * 0.9;
    globo.add(cristal);

    mundo.scale.set(2.8, 2.8, 2.8);
    mundo.position.set(0, GLOBO_RADIO * 0.35, 0);
    globo.add(mundo);

    var copos = new THREE.Group();
    for (var i = 0; i < 300; i++) {
      var copo = new THREE.Mesh(
        new THREE.SphereGeometry(0.15, 8, 8),
        new THREE.MeshLambertMaterial({ color: 0xffffff })
      );
      copo.position.set(
        (Math.random() - 0.5) * (GLOBO_RADIO * 1.8),
        Math.random() * (GLOBO_RADIO * 1.6),
        (Math.random() - 0.5) * (GLOBO_RADIO * 1.8)
      );
      copos.add(copo);
    }
    copos.position.y = GLOBO_RADIO * 0.9;
    globo.add(copos);

    // ----------------------------- GAZE -----------------------------
    var raycaster = new THREE.Raycaster();
    var gazeTargets = [
      { name: 'casa', mesh: casa, timer: 0, triggered: false },
      { name: 'pinguino', mesh: pinguino, timer: 0, triggered: false },
      { name: 'arbol', mesh: tree, timer: 0, triggered: false }
    ];

    var GAZE_THRESHOLD = 2000; // ms

    function startTour(targetMesh) {
      if (cameraRig.userData.moving) return;
      cameraRig.userData.moving = true;

      var targetWorld = new THREE.Vector3();
      targetMesh.getWorldPosition(targetWorld);

      var offset = new THREE.Vector3(0, 1.2, 2.0);
      var toPos = targetWorld.clone().add(offset);

      var from = cameraRig.position.clone();
      var coords = { x: from.x, y: from.y, z: from.z };

      new TWEEN.Tween(coords)
        .to({ x: toPos.x, y: toPos.y, z: toPos.z }, 1800)
        .easing(TWEEN.Easing.Quadratic.Out)
        .onUpdate(function(){ cameraRig.position.set(coords.x, coords.y, coords.z); })
        .onComplete(function(){
          cameraRig.userData.moving = false;
          cameraRig.lookAt(targetWorld);
        })
        .start();
    }

    function animate() {
      TWEEN.update();

      var camPos = new THREE.Vector3();
      camera.getWorldPosition(camPos);

      // ⭐⭐⭐ CORRECCIÓN ÚNICA (raycaster según mirada) ⭐⭐⭐
      var direction = new THREE.Vector3();
      camera.getWorldDirection(direction);
      raycaster.set(camPos, direction);

      var intersects = raycaster.intersectObjects([casa, pinguino, tree], true);

      var now = performance.now();
      if (typeof animate.lastTime === 'undefined') animate.lastTime = now;
      var delta = now - animate.lastTime;
      animate.lastTime = now;

      gazeTargets.forEach(function(gt){
        var found = false;
        for(var i=0; i<intersects.length; i++){
          var obj = intersects[i].object;
          var p = obj;
          for(var depth=0; depth<8; depth++){
            if (!p) break;
            if (p === gt.mesh) { found = true; break; }
            p = p.parent;
          }
          if (found) break;
        }

        if (found && !gt.triggered) {
          gt.timer += delta;
          gt.mesh.scale.lerp(new THREE.Vector3(1.02,1.02,1.02), 0.08);
          if (gt.timer >= GAZE_THRESHOLD) {
            gt.triggered = true;
            startTour(gt.mesh);
            gt.mesh.scale.set(1,1,1);
          }
        } else {
          gt.mesh.scale.lerp(new THREE.Vector3(1,1,1), 0.08);
          if (!found) gt.timer = 0;
        }
      });

      renderer.render(scene, camera);
    }

    renderer.setAnimationLoop(animate);

    window.addEventListener('resize', function(){
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    cameraRig.position.set(0, 0.6, 3);
  </script>
</body>
</html>
